# SOME DESCRIPTIVE TITLE
# Copyright (C) YEAR Free Software Foundation, Inc.
# This file is distributed under the same license as the PACKAGE package.
# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.
#
#, fuzzy
msgid ""
msgstr ""
"Project-Id-Version: PACKAGE VERSION\n"
"POT-Creation-Date: 2023-11-02 09:18+0000\n"
"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
"Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
"Language-Team: LANGUAGE <LL@li.org>\n"
"Language: zh_CN\n"
"MIME-Version: 1.0\n"
"Content-Type: text/plain; charset=UTF-8\n"
"Content-Transfer-Encoding: 8bit\n"

#. type: YAML Front Matter: author
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:1
#, no-wrap
msgid "zakkak"
msgstr ""

#. type: YAML Front Matter: date
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:1
#, no-wrap
msgid "2023-11-02"
msgstr ""

#. type: YAML Front Matter: layout
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:1
#, no-wrap
msgid "post"
msgstr ""

#. type: YAML Front Matter: synopsis
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:1
#, no-wrap
msgid "A comprehensive analysis attributing binary size increase to specific changes in Mandrel's code base."
msgstr ""

#. type: YAML Front Matter: tags
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:1
#, no-wrap
msgid "native graalvm mandrel metrics"
msgstr ""

#. type: YAML Front Matter: title
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:1
#, no-wrap
msgid "Exploring why native executables produced with Mandrel 23.0 are bigger than those produced with Mandrel 22.3"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:11
#, no-wrap
msgid "Starting with Quarkus 3.2 the default Mandrel version was updated from 22.3 to 23.0.\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:13
#, no-wrap
msgid "This update brought a number of bugfixes as well as new features like:\n"
msgstr ""

#. type: Bullet: '1. '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:17
#, no-wrap
msgid "Better support for profiling and debugging using `perf` and `gdb`.\n"
msgstr ""

#. type: Bullet: '2. '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:17
#, no-wrap
msgid "Finer control over the monitoring features included in the native executable.\n"
msgstr ""

#. type: Bullet: '3. '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:17
#, no-wrap
msgid "Support for more JFR events.\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:21
#, no-wrap
msgid ""
"However, it also brought an unwanted side effect.\n"
"The native executables produced with Mandrel 23.0 are bigger than the ones produced with Mandrel 22.3.\n"
"To better understand why that happens we perform a thorough analysis to attribute the size increase to specific changes in Mandrel's code base.\n"
msgstr ""

#. type: Title ##
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:22
#, fuzzy, no-wrap
msgid "TL;DR"
msgstr "TL;DR"

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:25
#, no-wrap
msgid "According to our analysis the binary size increase is attributed to three distinct changes, all of which are well justified:\n"
msgstr ""

#. type: Bullet: '1. '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:29
#, no-wrap
msgid "[Skipping constant folding of reflection methods with side effects](https://github.com/oracle/graal/pull/5156).\n"
msgstr ""

#. type: Bullet: '2. '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:29
#, no-wrap
msgid "[Reducing the number of stores that are executed by the serial GC write barriers to improve performance by reducing the number of cache misses](https://github.com/oracle/graal/pull/5330).\n"
msgstr ""

#. type: Bullet: '3. '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:29
#, no-wrap
msgid "[Enabling code alignment to compensate for the performance penalty of Intel's jump conditional code erratum](https://github.com/oracle/graal/commit/4de58f1b3c484213951622c03d74f3435a20c4ef#diff-991a434bbfc9a6af5514e4609380d5fbfe7618585d5b1b3f11fa2a7431ca7ab0L1388-R1388).\n"
msgstr ""

#. type: Title ##
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:30
#, no-wrap
msgid "Better understanding what is different between the generated native executables"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:34
#, no-wrap
msgid ""
"The first step in our analysis is to understand where the binary size increase comes from.\n"
"Usually such an increase is attributed to one of the following:\n"
msgstr ""

#. type: Bullet: '1. '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:39
#, no-wrap
msgid "More code being generated, due to more code becoming reachable.\n"
msgstr ""

#. type: Bullet: '2. '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:39
#, no-wrap
msgid "More code being generated, due to more aggressive inlining.\n"
msgstr ""

#. type: Bullet: '3. '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:39
#, no-wrap
msgid "More data being stored in the image heap, due to more objects being reachable.\n"
msgstr ""

#. type: Bullet: '4. '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:39
#, no-wrap
msgid "More data being stored in the image heap, due to more types being registered for reflection thus requiring more code metadata to be stored.\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:42
#, no-wrap
msgid ""
"To perform the analysis we use the [Quarkus startstop test](https://github.com/quarkus-qe/quarkus-startstop) (specifically commit `a8bae846881607e376c7c8a96116b6b50ee50b70`) which generates, starts, tests, and stops small Quarkus applications and measures various time-related metrics (e.g. time-to-first-OK-request) and memory usage.\n"
"We get the test with:\n"
msgstr ""

#. type: Fenced code block (shell)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:43
#, no-wrap
msgid ""
"git clone https://github.com/quarkus-qe/quarkus-startstop\n"
"cd quarkus-startstop\n"
"git checkout a8bae846881607e376c7c8a96116b6b50ee50b70\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:50
#, no-wrap
msgid "and build it with:\n"
msgstr ""

#. type: Fenced code block (shell)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:51
#, no-wrap
msgid ""
"mvn clean package -Pnative -Dquarkus.version=3.2.6.Final\\\n"
"    -Dquarkus.native.builder-image=quay.io/quarkus/ubi-quarkus-mandrel-builder-image:jdk-17\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:57
#, no-wrap
msgid "changing the builder image tag to `22.3-java17` for building with Mandrel 22.3.\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:59
#, no-wrap
msgid "Looking at the build output (generated by Quarkus in `target/my-app-native-image-sources/my-app-build-output-stats.json`) the main differences between the two builds are in the following metrics:\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:66
#, no-wrap
msgid ""
"| Mandrel version | 22.3.3.1 | 23.0.1.2 | Increase %\n"
"| --- | --- | --- | --- |\n"
"| Image Heap Size | 28807168 | 29499392 | 2.4\n"
"| Image Code Area | 27680208 | 29625424 | 7\n"
"| Total Image Size | 56826648 | 59467728 | 4.6\n"
"| Classes registered for reflection | 645 | 4317 | 570\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:68
#, no-wrap
msgid "Hinting that any of the reasons 1-4 mentioned above is possible.\n"
msgstr ""

#. type: Title ###
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:69
#, no-wrap
msgid "Dashboards"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:73
#, no-wrap
msgid ""
"GraalVM and Mandrel provide the `-H:+DashboardAll` and `-H:+DashboardJson` flags that can be used to generate dashboards that contain more information about the generated native executable.\n"
"The resulting dashboard contains a number of metrics and looks like this:\n"
msgstr ""

#. type: Fenced code block (json)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:74
#, no-wrap
msgid ""
"{\n"
"  \"points-to\": {\n"
"    \"type-flows\": [\n"
"      ...\n"
"    ]\n"
"  },\n"
"  \"code-breakdown\": {\n"
"    \"code-size\": [\n"
"      {\n"
"        \"name\": \"io.smallrye.mutiny.CompositeException.getFirstOrFail(Throwable[]) Throwable\",\n"
"        \"size\": 575\n"
"      },\n"
"      ...\n"
"    ]\n"
"  },\n"
"  \"heap-breakdown\": {\n"
"    \"heap-size\": [\n"
"      {\n"
"        \"name\": \"Lio/vertx/core/impl/VerticleManager$$Lambda$bf09d38f5d19578a0d041ffd0a524c1cbe1843df;\",\n"
"        \"size\": 24,\n"
"        \"count\": 1\n"
"      },\n"
"      ...\n"
"    ]\n"
"  }\n"
"}\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:104
#, no-wrap
msgid "Using the aforementioned flags we generate dashboards using both Mandrel 22.3 and 23.0 and compare the results.\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:106
#, no-wrap
msgid "To generate the dashboards using Mandrel 23.0 we use the following command:\n"
msgstr ""

#. type: Fenced code block (shell)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:107
#, no-wrap
msgid ""
"mvn package -Pnative \\\n"
"  -Dquarkus.version=3.2.6.Final \\\n"
"  -Dquarkus.native.builder-image=quay.io/quarkus/ubi-quarkus-mandrel-builder-image:jdk-17 \\\n"
"  -Dquarkus.native.additional-build-args=-H:+DashboardAll,-H:+DashboardJson,-H:DashboardDump=path/to/23.0.dashboard.json\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:115
#, no-wrap
msgid "Similarly to generate the dashboards using Mandrel 22.3 we use the following command:\n"
msgstr ""

#. type: Fenced code block (shell)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:116
#, no-wrap
msgid ""
"mvn package -Pnative \\\n"
"  -Dquarkus.version=3.2.6.Final \\\n"
"  -Dquarkus.native.builder-image=quay.io/quarkus/ubi-quarkus-mandrel-builder-image:22.3-java17 \\\n"
"  -Dquarkus.native.additional-build-args=-H:+DashboardAll,-H:+DashboardJson,-H:DashboardDump=path/to/22.3.dashboard.json\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:124
#, no-wrap
msgid "Note: Make sure to change `path/to/` to the path where you would like the dashboard json files to be stored, each file is about 370MB big.\n"
msgstr ""

#. type: Title ###
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:125
#, no-wrap
msgid "Analyzing and visualizing the data"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:129
#, no-wrap
msgid ""
"To process the data from the dashboards we used a Jupyter notebook, like we did to create this article.\n"
"To grab the notebook follow [this link](/assets/examples/posts/mandrel-23-0-image-size-increase/quarkus-size-22-3-23-0.ipynb).\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:132
#, no-wrap
msgid ""
"For those willing to use a spreadsheet instead, a CSV file can be created to facilitate the analysis in a spreadsheet.\n"
"E.g. using `jq`:\n"
msgstr ""

#. type: Fenced code block (shell)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:133
#, no-wrap
msgid "jq -r -s '([\"Name\", \"22.3 size\", \"23.0 size\"], (map(.\"code-breakdown\".\"code-size\") | flatten | group_by(.name) | map({name: .[0].name, size22: .[0].size, size23: .[1].size})[] | [.name, .size22, .size23])) | @csv' 22.3.dashboard.json 23.0.dashboard.json > analysis.csv\n"
msgstr ""

#. type: Title ####
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:137
#, no-wrap
msgid "Loading the data from the json files"
msgstr ""

#. type: Fenced code block (python)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:140
#, no-wrap
msgid ""
"import json\n"
"import pandas as pd\n"
"\n"
"# load data from JSON file\n"
"with open('22.3.dashboard.json', 'r') as f:\n"
"    data22_3 = json.load(f)\n"
"with open('23.0.dashboard.json', 'r') as f:\n"
"    data23_0 = json.load(f)\n"
"\n"
"# create dataframes from json data\n"
"df22_3 = pd.DataFrame(data22_3)\n"
"df23_0 = pd.DataFrame(data23_0)\n"
"\n"
msgstr ""

#. type: Title ##
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:157
#, no-wrap
msgid "Key Observations"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:160
#, no-wrap
msgid "The key questions we want to answer using the aforementioned data are:\n"
msgstr ""

#. type: Bullet: '1. '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:165
#, no-wrap
msgid "Is the code area bigger due to more methods being compiled?\n"
msgstr ""

#. type: Bullet: '2. '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:165
#, no-wrap
msgid "Is the code area bigger due to more code being generated per method?\n"
msgstr ""

#. type: Bullet: '3. '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:165
#, no-wrap
msgid "Is the heap image bigger because we store more objects in it? \n"
msgstr ""

#. type: Bullet: '4. '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:165
#, no-wrap
msgid "Is the heap image bigger because we store more metadata?\n"
msgstr ""

#. type: Title ###
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:166
#, no-wrap
msgid "Code Area Size Increase"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:169
#, no-wrap
msgid "We first answer the code area related questions. \n"
msgstr ""

#. type: Title ####
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:170
#, no-wrap
msgid "Is the code area bigger due to more methods being compiled?"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:173
#, no-wrap
msgid "To answer this question we get the two lists of the compiled methods and compare their sizes:\n"
msgstr ""

#. type: Fenced code block (python)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:175
#, no-wrap
msgid ""
"# Get code-size lists from dataframes\n"
"code_size_22_3 = df22_3['code-breakdown']['code-size']\n"
"code_size_23_0 = df23_0['code-breakdown']['code-size']\n"
"\n"
"print(\"Compiled methods with 22_3:\", len(code_size_22_3))\n"
"print(\"Compiled methods with 23_0:\", len(code_size_23_0))\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:186
#, no-wrap
msgid ""
"    Compiled methods with 22_3: 46298\n"
"    Compiled methods with 23_0: 46299\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:191
#, no-wrap
msgid ""
"The results indicate that the answer is no.\n"
"In both cases the number of compiled methods is the same (off by 1).\n"
"As a result the code size increase is not coming from more methods becoming reachable and compiled.\n"
msgstr ""

#. type: Title ####
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:192
#, no-wrap
msgid "Is the code area bigger due to more code being generated per method?"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:195
#, no-wrap
msgid "To answer this question we calculate the percentage difference between the compiled methods:\n"
msgstr ""

#. type: Fenced code block (python)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:197
#, no-wrap
msgid ""
"import matplotlib.pyplot as plt\n"
"\n"
"# create dataframes from code_size lists\n"
"code_df22_3 = pd.DataFrame(code_size_22_3).rename(columns={'size': 'size-22.3'})\n"
"code_df23_0 = pd.DataFrame(code_size_23_0).rename(columns={'size': 'size-23.0'})\n"
"\n"
"# merge dataframes\n"
"merged_df = pd.merge(code_df22_3, code_df23_0, on='name', how='outer').fillna(0)\n"
"\n"
"# create column with size increase as percentage skipping entries with 0 size\n"
"percentage_increase = lambda row: (\n"
"    ((row['size-23.0'] - row['size-22.3']) / row['size-22.3']) * 100 \n"
"    if row['size-22.3'] > 0 and row['size-23.0'] > 0 \n"
"    else 0\n"
")\n"
"merged_df['size-increase'] = merged_df.apply(percentage_increase, axis=1)\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:217
#, no-wrap
msgid "We count the number of methods, the number of those that didn't change size, the number of those that their size increased, and the number of those that their size decreased:\n"
msgstr ""

#. type: Fenced code block (python)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:219
#, no-wrap
msgid ""
"total_compiled_methods = len(merged_df)\n"
"print(f\"Total number of compiled methods: {total_compiled_methods}\")\n"
"zero_increase_count = (merged_df['size-increase'] == 0).sum()\n"
"zero_increase_percent = (zero_increase_count / total_compiled_methods) * 100\n"
"print(f\"Number of methods that their compiled size remains the same: {zero_increase_count} ({zero_increase_percent:.2f}%)\")\n"
"positive_increase_count = (merged_df['size-increase'] > 0).sum()\n"
"positive_increase_percent = (positive_increase_count / total_compiled_methods) * 100\n"
"print(f\"Number of methods that their compiled size increased: {positive_increase_count} ({positive_increase_percent:.2f}%)\")\n"
"negative_increase_count = (merged_df['size-increase'] < 0).sum()\n"
"negative_increase_percent = (negative_increase_count / total_compiled_methods) * 100\n"
"print(f\"Number of methods that their compiled size decreased: {negative_increase_count} ({negative_increase_percent:.2f}%)\")\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:237
#, no-wrap
msgid ""
"    Total number of compiled methods: 48476\n"
"    Number of methods that their compiled size remains the same: 13947 (28.77%)\n"
"    Number of methods that their compiled size increased: 33351 (68.80%)\n"
"    Number of methods that their compiled size decreased: 1178 (2.43%)\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:242
#, no-wrap
msgid ""
"The results indicate that 68.8% of the compiled methods are bigger when compiled by 23.0 in comparison to when they are compiled by 22.3.\n"
"But how much bigger?\n"
"To answer this we print a histogram of the size increase:\n"
msgstr ""

#. type: Fenced code block (python)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:244
#, no-wrap
msgid ""
"# plot histogram\n"
"plt.hist(merged_df['size-increase'], bins=\"auto\")\n"
"plt.xlabel('Percentage difference')\n"
"plt.ylabel('Frequency')\n"
"plt.title('Histogram of percentage difference in code size (full range)')\n"
"plt.show()\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:256
#, no-wrap
msgid "![png](/assets/images/posts/mandrel-23-0-image-size-increase/index_9_0.png)\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:261
#, no-wrap
msgid ""
"We observe that due to a large number of methods retaining the same size and due to some outliers the histogram is hard to read.\n"
"So we remove the methods with no size changes and limit our focus in the range [-5, 25]:\n"
msgstr ""

#. type: Fenced code block (python)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:263
#, no-wrap
msgid ""
"# create column with size increase as percentage skipping entries with 0 size\n"
"zero_filter = lambda row: row['size-increase'] if row['size-increase'] != 0 else None\n"
"merged_df['size-increase'] = merged_df.apply(zero_filter, axis=1)\n"
"\n"
"# drop rows with None values\n"
"merged_df = merged_df.dropna()\n"
"\n"
"# plot histogram\n"
"plt.hist(merged_df['size-increase'], bins=\"auto\")\n"
"plt.xlim(-5, 25)\n"
"plt.xlabel('Percentage difference')\n"
"plt.ylabel('Frequency')\n"
"plt.title('Histogram of percentage difference in code size in the range [-5%, 25%] excluding 0%')\n"
"# show the plot\n"
"plt.show()\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:284
#, no-wrap
msgid "![png](/assets/images/posts/mandrel-23-0-image-size-increase/index_11_0.png)\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:288
#, no-wrap
msgid "This plot shows that the majority of the affected methods get a code size increase between 0 and 10 %, which is inline with the overall size increase we observe in the code area.\n"
msgstr ""

#. type: Title #####
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:289
#, no-wrap
msgid "Why?"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:294
#, no-wrap
msgid ""
"To see why the same methods get compiled to larger machine code when using Mandrel 23.0 we first inspected how many methods are getting inlined in each case.\n"
"To do so, we build the native executables with debug info generation enabled using the `-Dquarkus.native.debug.enabled=true` parameter.\n"
"To make sure that inline DIEs are included when building with Mandrel 22.3 we also pass the `-Dquarkus.native.additional-build-args=-H:-OmitInlinedMethodDebugLineInfo` option, e.g.:\n"
msgstr ""

#. type: Fenced code block (shell)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:295
#, no-wrap
msgid ""
"mvn clean package -Pnative -Dquarkus.version=3.2.6.Final\\\n"
"    -Dquarkus.native.builder-image=quay.io/quarkus/ubi-quarkus-mandrel-builder-image:jdk-17\\\n"
"    -Dquarkus.native.debug.enabled=true\\\n"
"    -Dquarkus.native.additional-build-args=-H:-OmitInlinedMethodDebugLineInfo\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:303
#, no-wrap
msgid "After the image is built we count the number of _inlined_ Debug Info Entries (DIEs) using the following command:\n"
msgstr ""

#. type: Fenced code block (shell)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:304
#, no-wrap
msgid "readelf --debug-dump=info quarkus-runner | grep -i \"DW_TAG_inlined_subroutine\" | wc -l\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:309
#, no-wrap
msgid "The results are shown in the table below:\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:313
#, no-wrap
msgid ""
"| Mandrel version | 22.3 | 23.0 | Increase % |\n"
"| --- | --- | --- | --- |\n"
"| Inlined methods | 2798414 | 2817686 | 0.69 % |\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:315
#, no-wrap
msgid "While they indicate a slight increase in the number of inlined methods between Mandrel 22.3 and 23.0, the increase is so small that it doesn't align with the overall code size increase.\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:317
#, no-wrap
msgid "As a next step, we hand-picked a number of methods with different code sizes in the generated native executables and inspected their disassembled code (using `gdb`).\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:319
#, no-wrap
msgid "For example inspecting `InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf.allocateDirect(int)` from `io.netty.buffer.UnpooledByteBufAllocator` using:\n"
msgstr ""

#. type: Fenced code block (gdb)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:320
#, no-wrap
msgid "(gdb) x/20i 'io.netty.buffer.UnpooledByteBufAllocator$InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf::allocateDirect(int)'\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:325
#, no-wrap
msgid "we see that the one extra byte comes from an additional `nop` between two calls.\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:327
#, no-wrap
msgid "**Mandrel 22.3**\n"
msgstr ""

#. type: Fenced code block (asm)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:328
#, no-wrap
msgid ""
"sub    $0x18,%rsp\n"
"cmp    0x8(%r15),%rsp\n"
"jbe    0x96ad8f\n"
"mov    %rdi,0x8(%rsp)\n"
"mov    %esi,%edi\n"
"mov    %esi,0x14(%rsp)\n"
"call   0xb7e870\n"
"nop\n"
"call   0x756e10\n"
"nop\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:342
#, no-wrap
msgid "**Mandrel 23.0**\n"
msgstr ""

#. type: Fenced code block (asm)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:343
#, no-wrap
msgid ""
"sub    $0x18,%rsp\n"
"cmp    0x8(%r15),%rsp\n"
"jbe    0x96ad8f\n"
"mov    %rdi,0x8(%rsp)\n"
"mov    %esi,%edi\n"
"mov    %esi,0x14(%rsp)\n"
"call   0xb7e870\n"
"nop\n"
"nop                     // <==== extra nop\n"
"call   0x756e10\n"
"nop\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:359
#, no-wrap
msgid ""
"We observed this pattern in multiple methods which is an indication of some code alignment change.\n"
"However, there were also methods with increased compiled code size without having an increased number of `nop`s, hinting that the code size increase is not caused by a single change as we confirm in [Attributing Binary Size Increase to Specific Code Changes](#attributing-binary-size-increase-to-specific-code-changes).\n"
msgstr ""

#. type: Title ###
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:360
#, no-wrap
msgid "Image Heap Size Increase"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:364
#, no-wrap
msgid ""
"Upon initial inspection, it was noted that there was an increase of approximately 650KB in the image heap size.\n"
"As a result next we opted to answer whether:\n"
msgstr ""

#. type: Bullet: '1. '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:367
#, no-wrap
msgid "The heap image is bigger because we store more objects in it? \n"
msgstr ""

#. type: Bullet: '2. '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:367
#, no-wrap
msgid "The heap image is bigger because we store more metadata?\n"
msgstr ""

#. type: Title ####
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:368
#, no-wrap
msgid "Is the heap image bigger because we store more objects in it?"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:371
#, no-wrap
msgid "Using the dashboard data we first checked whether the number of objects in the image heap is different between the two versions:\n"
msgstr ""

#. type: Fenced code block (python)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:373
#, no-wrap
msgid ""
"# Get heap-size lists from dataframes\n"
"heap_size_22_3 = df22_3['heap-breakdown']['heap-size']\n"
"heap_size_23_0 = df23_0['heap-breakdown']['heap-size']\n"
"\n"
"# create dataframes from heap_size lists\n"
"heap_df22_3 = pd.DataFrame(heap_size_22_3).rename(columns={'size': 'size-22.3', 'count': 'count-22.3'})\n"
"heap_df23_0 = pd.DataFrame(heap_size_23_0).rename(columns={'size': 'size-23.0', 'count': 'count-23.0'})\n"
"\n"
"print(\"Number of objects in image heap with 22.3: \", heap_df22_3['count-22.3'].sum())\n"
"print(\"Number of objects in image heap with 23.0: \", heap_df23_0['count-23.0'].sum())\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:388
#, no-wrap
msgid ""
"    Number of objects in image heap with 22.3:  340870\n"
"    Number of objects in image heap with 23.0:  348063\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:392
#, no-wrap
msgid ""
"We observe that the image generated with 22.3 has ~7000 (or roughly 2%) more objects in the image heap.\n"
"We then check to see if these additional objects are from different types being instantiated:\n"
msgstr ""

#. type: Fenced code block (python)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:394
#, no-wrap
msgid ""
"print(\"Types in image heap with 22.3:\", len(heap_size_22_3))\n"
"print(\"Types in image heap with 23.0:\", len(heap_size_23_0))\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:401
#, no-wrap
msgid ""
"    Types in image heap with 22.3: 3681\n"
"    Types in image heap with 23.0: 3679\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:405
#, no-wrap
msgid ""
"The results indicate that the number of types in the image heap remain about the same, hinting that 23.0 instantiates more objects of the same types in the image heap.\n"
"To see which types are those seeing the larger, in terms of heap size, increase in the image heap we run:\n"
msgstr ""

#. type: Fenced code block (python)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:407
#, no-wrap
msgid ""
"# merge dataframes\n"
"merged_heap_df = pd.merge(heap_df22_3, heap_df23_0, on='name', how='outer').fillna(0)\n"
"merged_heap_df['count-diff'] = merged_heap_df['count-23.0'] - merged_heap_df['count-22.3']\n"
"merged_heap_df['size-diff'] = merged_heap_df['size-23.0'] - merged_heap_df['size-22.3']\n"
"# get top 10 types with the biggest difference in occupied heap size\n"
"merged_heap_df.sort_values(by=['size-diff'], ascending=False).head(10)[['name', 'count-diff', 'size-diff']]\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:424
#, no-wrap
msgid ""
"<div>\n"
"<style scoped>\n"
"    .dataframe tbody tr th:only-of-type {\n"
"        vertical-align: middle;\n"
"    }\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:428
#, no-wrap
msgid ""
"    .dataframe tbody tr th {\n"
"        vertical-align: top;\n"
"    }\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:506
#, no-wrap
msgid ""
"    .dataframe thead th {\n"
"        text-align: right;\n"
"    }\n"
"</style>\n"
"<table border=\"1\" class=\"dataframe\">\n"
"  <thead>\n"
"    <tr style=\"text-align: right;\">\n"
"      <th></th>\n"
"      <th>name</th>\n"
"      <th>count-diff</th>\n"
"      <th>size-diff</th>\n"
"    </tr>\n"
"  </thead>\n"
"  <tbody>\n"
"    <tr>\n"
"      <th>1340</th>\n"
"      <td>[B</td>\n"
"      <td>2042.0</td>\n"
"      <td>894704.0</td>\n"
"    </tr>\n"
"    <tr>\n"
"      <th>2384</th>\n"
"      <td>Ljava/lang/invoke/DirectMethodHandle;</td>\n"
"      <td>1293.0</td>\n"
"      <td>71920.0</td>\n"
"    </tr>\n"
"    <tr>\n"
"      <th>2901</th>\n"
"      <td>Ljava/lang/String;</td>\n"
"      <td>2032.0</td>\n"
"      <td>65024.0</td>\n"
"    </tr>\n"
"    <tr>\n"
"      <th>3684</th>\n"
"      <td>Ljdk/internal/module/ServicesCatalog$ServicePr...</td>\n"
"      <td>1058.0</td>\n"
"      <td>42320.0</td>\n"
"    </tr>\n"
"    <tr>\n"
"      <th>2582</th>\n"
"      <td>[Ljava/lang/Object;</td>\n"
"      <td>246.0</td>\n"
"      <td>36472.0</td>\n"
"    </tr>\n"
"    <tr>\n"
"      <th>898</th>\n"
"      <td>[Ljava/lang/String;</td>\n"
"      <td>9.0</td>\n"
"      <td>28024.0</td>\n"
"    </tr>\n"
"    <tr>\n"
"      <th>1297</th>\n"
"      <td>Ljava/lang/invoke/MethodType;</td>\n"
"      <td>276.0</td>\n"
"      <td>15456.0</td>\n"
"    </tr>\n"
"    <tr>\n"
"      <th>3238</th>\n"
"      <td>Ljava/util/concurrent/ConcurrentHashMap$Node;</td>\n"
"      <td>274.0</td>\n"
"      <td>13152.0</td>\n"
"    </tr>\n"
"    <tr>\n"
"      <th>1065</th>\n"
"      <td>Ljava/util/HashMap;</td>\n"
"      <td>146.0</td>\n"
"      <td>10512.0</td>\n"
"    </tr>\n"
"    <tr>\n"
"      <th>3244</th>\n"
"      <td>[Ljava/lang/Class;</td>\n"
"      <td>261.0</td>\n"
"      <td>9680.0</td>\n"
"    </tr>\n"
"  </tbody>\n"
"</table>\n"
"</div>\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:510
#, no-wrap
msgid "The results indicate an increase of ~870KB of bytes in byte arrays, which unfortunately is not very informative, especially combined with the size of other types significantly differing between the two versions (possibly due to GraalVM internal code changes which result in different allocation patterns).\n"
msgstr ""

#. type: Title ####
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:511
#, no-wrap
msgid "Is the heap image bigger because we store more metadata?"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:517
#, no-wrap
msgid ""
"As shown in [Better understanding what is different between the generated native executables](#better-understanding-what-is-different-between-the-generated-native-executables) there appears to be a significant increase in the number of types registered for reflection (645 in Mandrel 22.3 vs. 4317 in Mandrel 23.0).\n"
"This, along with the reported (in the `native-image` output) increase of code metadata, initially led us to think that there is some change in Mandrel that results in more types being registered for reflection.\n"
"In the end, as discussed in [Attributing Binary Size Increase to Specific Code Changes](#attributing-binary-size-increase-to-specific-code-changes), contrary to our intuition, the increase is not related to the increase in the reported types registered for reflection which is due to [a fix in the way the reported types registered for reflection are measured](https://github.com/oracle/graal/commit/23d70b802b2dbc9b7d2324a31141c32b6575083f#diff-54ef73a23b10bd907d5869cc88b651fae7fef0467ccfaf8f50472cdd1e114eceR385).\n"
"Instead, the increase of the code metadata stored in the image heap is due to [skipping constant folding of reflection methods with side effects](https://github.com/oracle/graal/pull/5156), a fix introduced in 23.0 to prevent undesired effects when folding invocations using reflection.\n"
msgstr ""

#. type: Title ##
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:518
#, no-wrap
msgid "Attributing Binary Size Increase to Specific Code Changes"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:522
#, no-wrap
msgid ""
"At this point, we have a rough understanding of what is different in the generated native executables, but we still don't know why.\n"
"Is this increase in the size of native executables well justified?\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:531
#, no-wrap
msgid ""
"To answer this question, we decided to detect the code base changes that resulted in the observed behaviors.\n"
"To do so, we used `git bisect`, marking the 22.3 release's commit as _good_ and the 23.0 release's commit as _bad_.\n"
"For each commit, we built an instance of Mandrel and compiled our test application to see the code and heap area size.\n"
"If the sizes matched the ones from 22.3, we marked the commit as _good_ otherwise we marked it as _bad_.\n"
"During this process, we noticed that there were commits resulting in binary sizes bigger than the ones generated with 22.3 but smaller than 23.0.\n"
"This confirmed our expectation that the binary size increase was the result of more than one change in the code base.\n"
"To reduce the `git bisect` cost we noted down the code and heap area sizes for each tested commit hash.\n"
"Then using that info, we replayed the bisect process a few times using the output of `git bisect log` and changing which commits we considered _good_, once we identified the first, second, and so forth change contributing to the binary size increase.\n"
msgstr ""

#. type: Title ###
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:532
#, no-wrap
msgid "Identified Causes of Code Size Increase"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:535
#, no-wrap
msgid "The above process led us to the conclusion that the binary size increase is mainly mainly the result of the following three changes:\n"
msgstr ""

#. type: Bullet: '- '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:538
#, no-wrap
msgid ""
"[**Skipping constant folding of reflection methods with side effects**](https://github.com/oracle/graal/pull/5156): A fix introduced in 23.0 to prevent undesired effects when folding invocations using reflection (e.g. triggering build time initialization of classes that should be run time initialized).\n"
"This change is responsible for the image heap size increase.\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:544
#, no-wrap
msgid ""
"- [**Reducing the number of stores that are executed by the serial GC write barriers to improve performance by reducing the number of cache misses**](https://github.com/oracle/graal/pull/5330): This change essentially adds two additional instructions, a `cmpb   $0x0,0x30(%rcx,%rax,1)` and a `je`, to each inlined instance of the serial GC write barrier.\n"
"  The aim of this change is to avoid unnecessary stores in the GC write barriers in order to reduce cache line invalidations and improve performance.\n"
"  According to our measurements, the total impact of this change is ~1MB increase of code area in our test case which inlines the write barrier 90697 times when using Mandrel 22.3 and 93686 times when using Mandrel 23.0.\n"
"  To measure the number the barrier was inlined we inspect the number of breakpoint locations set in `gdb` when running `b CardTable.java:91`, i.e. when setting a breakpoint in `com.oracle.svm.core.genscavenge.remset.CardTable#setDirty`.\n"
"  E.g.:\n"
msgstr ""

#. type: Fenced code block (gdb)
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:545
#, no-wrap
msgid ""
"  (gdb) b CardTable.java:91\n"
"  Breakpoint 1 at 0x407574: CardTable.java:91. (93686 locations)\n"
msgstr ""

#. type: Bullet: '- '
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:551
#, no-wrap
msgid "[**Enabling code alignment to compensate for the performance penalty of Intel's Jump Conditional Code Erratum**](https://github.com/oracle/graal/commit/4de58f1b3c484213951622c03d74f3435a20c4ef#diff-991a434bbfc9a6af5514e4609380d5fbfe7618585d5b1b3f11fa2a7431ca7ab0L1388-R1388): According to [Intel's white paper about \"Mitigations for Jump Conditional Code Erratum\"](https://www.intel.com/content/dam/support/us/en/documents/processors/mitigations-jump-conditional-code-erratum.pdf):\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:554
#, no-wrap
msgid ""
"  > Software can compensate for the performance effects of the workaround for this erratum with optimizations that align the code such that jump instructions (and macro-fused jump instructions) do not cross 32-byte boundaries or end on a 32-byte boundary.\n"
"  > Such aligning can reduce or eliminate the performance penalty caused by the transition of execution from Decoded ICache to the legacy decode pipeline.\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:556
#, no-wrap
msgid "  As a result, this change results in an increased number of `nop` instructions in the generated code, but can result in up to 4% performance improvements according to the same document:\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:562
#, no-wrap
msgid ""
"  > Intel has observed performance effects associated with the workaround ranging from\n"
"0-4% on many industry-standard benchmarks.\n"
"  > In subcomponents of these benchmarks, Intel has observed outliers higher than the 0-4% range.\n"
"  > Other workloads not observed by Intel may behave differently.\n"
"  > Intel has in turn developed software-based tools to minimize the impact on potentially affected applications and workloads.\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:564
#, no-wrap
msgid "   According to our measurements, the total impact of this change is ~900KB in our test case.\n"
msgstr ""

#. type: Title ##
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:565
#, no-wrap
msgid "Conclusion"
msgstr "解决方案"

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:568
#, no-wrap
msgid "In conclusion, the increase in the size of native executables produced with Mandrel 23.0 compared to Mandrel 22.3 can be attributed to the above three specific changes in the Mandrel code base.\n"
msgstr ""

#. type: Plain text
#: upstream/_posts/2023-11-02-mandrel-23-0-image-size-increase.md:570
#, no-wrap
msgid ""
"While these changes do contribute to the increase in native executable size, they also come with performance and correctness benefits.\n"
"Therefore, the larger executables are a trade-off to ensure better application performance and avoid undesired side effects.\n"
msgstr ""
