<!DOCTYPE html>
<html lang="cn">







<head>
  <title>Using transactions in Quarkus - 3.2 - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://analytics.ossupstream.org/ https://search.quarkus.io https://smetrics.redhat.com https://ajax.googleapis.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://analytics.ossupstream.org/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://player.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />

  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/3.2/guides/transaction" />
  <meta property="og:title" content="Using transactions in Quarkus - 3.2" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/transaction">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="en" href="https://quarkus.io/version/3.2/guides/transaction" />
  
  <link rel="alternate" hreflang="pt-br" href="https://pt.quarkus.io/version/3.2/guides/transaction" />
  
  <link rel="alternate" hreflang="es" href="https://es.quarkus.io/version/3.2/guides/transaction" />
  
  <link rel="alternate" hreflang="zh" href="https://cn.quarkus.io/version/3.2/guides/transaction" />
  
  <link rel="alternate" hreflang="ja" href="https://ja.quarkus.io/version/3.2/guides/transaction" />
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="guides">

  


<div class="grid-wrapper communitysite">
  <div class="grid__item width-12-12">The <a href="https://quarkus.io/version/3.2/guides/transaction">English version of quarkus.io</a> is the official project site. Translated sites are community supported on a best-effort basis.</div>
</div>


  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="#">Why<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUS是什么？</a></li>
          <li><a href="/developer-joy" class="">开发者的乐趣 </a></li>
          <li><a href="/performance" class="">PERFORMANCE</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES 原生</a></li>
          <li><a href="/standards" class="">标准</a></li>
          <li><a href="/versatility" class="">VERSATILITY</a></li>
          <li><a href="/container-first" class="">容器优先 </a></li>
          <li><a href="/spring" class="">USING SPRING?</a></li>
          <li class="tertiarydropdown">
            <span href="#">AI<i class="fas fa-chevron-down"></i></span>
            <ul class="tertiarymenu">
              <li><a href="/ai" class="">AI OVERVIEW</a></li>
              <li><a href="/java-for-ai" class="">JAVA FOR AI</a></li>
              <li><a href="/quarkus-for-ai" class="">WHY QUARKUS FOR AI</a></li>
              <li><a href="/ai-blueprints" class="">AI BLUEPRINTS</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Learn<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入门</a></li>
          <li><a href="/guides" class="active" >指南</a></li>
          <li><a href="/userstories/" class="">USER STORIES</a></li>  
          <li><a href="/qtips" class="">"Q" TIP视频</a></li>          
          <li><a href="/books" class="">书籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="#">Extensions<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
<li><a href="https://quarkus.io/extensions/" class="">浏览扩展</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">使用扩展</a></li>
          <li><a href="/guides/writing-extensions" class="" >创建扩展</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">SHARE EXTENSIONS</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Community<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">支持</a></li>
          <li><a href="/blog" class="" >博客</a></li>
          <li><a href="/discussion" class="">讨论</a></li>
          <li><a href="/working-groups" class="">WORKING GROUPS</a></li>
          <li><a href="/insights" class="" >播客</a></li>
          <li><a href="/events" class="">活动</a></li>
          <li><a href="/newsletter" class="">新闻</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">路线图</a></li>
          <li><a href="/benefactors" class="">BENEFACTORS</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">开始编码</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/version/3.2/guides/transaction" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/version/3.2/guides/transaction">PORTUGUÊS (BR)</a></li>
          <li><a href="https://es.quarkus.io/version/3.2/guides/transaction">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/version/3.2/guides/transaction">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/version/3.2/guides/transaction">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas
fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    





<section class="full-width-version-bg flexfilterbar guides">
  <div class="guideflexcontainer">
    <div class="docslink">
      <a class="returnlink" href="/version/3.2/guides/">返回指南目录</a>
    </div>
    <div class="flexlabel">
      <label>选择指南版本</label>
    </div>
    <div class="guidepulldown version">
    <select id="guide-version-dropdown">
      
        
        
        <option value="main" >Main - SNAPSHOT</option>
        
        
        
        <option value="latest" >3.32.1 - Latest</option>
        
        
        
        <option value="3.27" >3.27</option>
        
        
        
        <option value="3.20" >3.20</option>
        
        
        
        <option value="3.15" >3.15</option>
        
        
        
        <option value="3.8" >3.8</option>
        </select>
    </div>
  </div>
</section>

<div class="guide">
  <div class="grid-wrapper">
    <div class="grid__item width-8-12 width-12-12-m">
      <h1 class="text-caps">Using transactions in Quarkus </h1>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The <code>quarkus-narayana-jta</code> extension provides a Transaction Manager that coordinates and expose transactions to your applications as described in the link: <a href="https://jakarta.ee/specifications/transactions/">Jakarta Transactions</a> specification, formerly known as Java Transaction API (JTA).</p>
</div>
<div class="paragraph">
<p>When discussing Quarkus transactions, this guide refers to Jakarta Transactions transaction style and uses only the term <em>transaction</em> to address them.</p>
</div>
<div class="paragraph">
<p>Also, Quarkus does not support distributed transactions.
This means that models that propagate transaction context, such as <a href="https://download.oracle.com/otndocs/jcp/7309-jts-1.0-spec-oth-JSpec/">Java Transaction Service</a> (JTS), REST-AT, WS-Atomic Transaction, and others, are not supported by the <code>narayana-jta</code> extension.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-it-up"><a class="anchor" href="#setting-it-up"></a>设置它</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在大多数情况下，你不需要担心设置它，因为需要它的扩展会简单地把它作为一个依赖项加入。例如，Hibernate ORM将包括事务管理器并对其进行正确设置。</p>
</div>
<div class="paragraph">
<p>如果你不使用Hibernate ORM而直接使用事务，你可能需要明确地将其作为一个依赖项加入，例如。在你的构建文件中添加以下内容：</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-narayana-jta&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.quarkus:quarkus-narayana-jta")</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="starting-and-stopping-transactions-defining-your-boundaries"><a class="anchor" href="#starting-and-stopping-transactions-defining-your-boundaries"></a>开始和停止事务：确定你的事务边界</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can define your transaction boundaries either declaratively with <code>@Transactional</code> or programmatically with <code>QuarkusTransaction</code>. You can also use
the JTA <code>UserTransaction</code> API directly, however this is less user-friendly than <code>QuarkusTransaction</code>.</p>
</div>
<div class="sect2">
<h3 id="declarative-approach"><a class="anchor" href="#declarative-approach"></a>声明式方法</h3>
<div class="paragraph">
<p>The easiest way to define your transaction boundaries is to use the <code>@Transactional</code> annotation on your entry method (<code>jakarta.transaction.Transactional</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class SantaClausService {

    @Inject ChildDAO childDAO;
    @Inject SantaClausDAO santaDAO;

    @Transactional <i class="conum" data-value="1"></i><b>(1)</b>
    public void getAGiftFromSanta(Child child, String giftDescription) {
        // some transaction work
        Gift gift = childDAO.addToGiftList(child, giftDescription);
        if (gift == null) {
            throw new OMGGiftNotRecognizedException(); <i class="conum" data-value="2"></i><b>(2)</b>
        }
        else {
            santaDAO.addToSantaTodoList(gift);
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>这个注解定义了你的事务边界，并将把这个调用包含在一个事务中。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A <code>RuntimeException</code> crossing the transaction boundaries will roll back the transaction.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>@Transactional</code> 可以用来在方法层或类层控制任何CDI bean的事务边界，以确保每个方法都是事务性的。这包括REST端点。</p>
</div>
<div class="paragraph">
<p>你可以通过 <code>@Transactional</code> 上的参数来控制是否以及如何启动事务：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@Transactional(REQUIRED)</code> (默认）：如果当前没有事务，则启动一个事务，否则保持现有的事务。</p>
</li>
<li>
<p><code>@Transactional(REQUIRES_NEW)</code> ：如果当前没有事务，则启动一个事务；如果已经启动了一个事务，则暂停该事务，并从该方法的边界开始重新启动一个新事务。</p>
</li>
<li>
<p><code>@Transactional(MANDATORY)</code> ：如果没有启动任何事务，则失败；否则在现有事务中工作。</p>
</li>
<li>
<p><code>@Transactional(SUPPORTS)</code> :如果一个事务已经开始，则加入它；否则在没有事务的情况下工作。</p>
</li>
<li>
<p><code>@Transactional(NOT_SUPPORTED)</code> 暂停事务：如果一个事务已经开始，则暂停事务，并在方法的边界内不使用事务；否则不使用事务。</p>
</li>
<li>
<p><code>@Transactional(NEVER)</code> :如果一个事务被启动，引发一个异常；否则在没有事务的情况下工作。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>REQUIRED</code> 或 <code>NOT_SUPPORTED</code> 可能是最有用的。它们决定一个方法是在事务内还是事务外运行。请确保查看JavaDoc以了解准确的语义。</p>
</div>
<div class="paragraph">
<p>正如你所期望的那样，事务上下文被传播并嵌套在 <code>@Transactional</code> 方法中的所有调用（在这个例子中 <code>childDAO.addToGiftList()</code> 和 <code>santaDAO.addToSantaTodoList()</code> ）。除非有运行时异常穿越方法边界，否则事务将会提交。你可以通过使用 <code>@Transactional(dontRollbackOn=SomeException.class)</code> （或 <code>rollbackOn</code> ）来覆盖异常是否强制回滚。</p>
</div>
<div class="paragraph">
<p>你也可以使用编程方式要求一个事务被标记为回滚。为此需要注入 <code>TransactionManager</code> 。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class SantaClausService {

    @Inject TransactionManager tm; <i class="conum" data-value="1"></i><b>(1)</b>
    @Inject ChildDAO childDAO;
    @Inject SantaClausDAO santaDAO;

    @Transactional
    public void getAGiftFromSanta(Child child, String giftDescription) {
        // some transaction work
        Gift gift = childDAO.addToGiftList(child, giftDescription);
        if (gift == null) {
            tm.setRollbackOnly(); <i class="conum" data-value="2"></i><b>(2)</b>
        }
        else {
            santaDAO.addToSantaTodoList(gift);
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>注入 <code>TransactionManager</code> ，能够激活 <code>setRollbackOnly</code> 语义。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>以编程方式决定将该事务设置为回滚。</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="transaction-configuration"><a class="anchor" href="#transaction-configuration"></a>Transaction configuration</h3>
<div class="paragraph">
<p>除了在你的入口方法上或在类的层面上设置标准的 <code>@Transactional</code> 注解之外，事务的高级配置还可以通过使用 <code>@TransactionConfiguration</code> 注解来实现。</p>
</div>
<div class="paragraph">
<p><code>@TransactionConfiguration</code> 注解允许设置一个超时属性，以秒为单位，适用于在注解方法中创建的事务。</p>
</div>
<div class="paragraph">
<p>这个注释只能放在划定事务的顶层方法上。一旦事务开始，被注解的嵌套方法将抛出一个异常。</p>
</div>
<div class="paragraph">
<p>如果在一个类上定义，就相当于在该类所有标有 <code>@Transactional</code> 的方法上定义了它。在方法上定义的配置优先于在类上定义的配置。</p>
</div>
</div>
<div class="sect2">
<h3 id="reactive-extensions"><a class="anchor" href="#reactive-extensions"></a>响应性扩展</h3>
<div class="paragraph">
<p>如果你的 <code>@Transactional</code> -注释的方法返回一个响应性的值，例如：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CompletionStage</code> (来自JDK)</p>
</li>
<li>
<p><code>Publisher</code> (来自Reactive-Streams)</p>
</li>
<li>
<p>Any type that can be converted to one of the two previous types using Reactive Type Converters</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>那么行为就有点不同了，因为在返回的响应式值终止之前，事务不会被终止。实际上，返回的响应式值将被监听，如果它意外终止，事务将被标记为回滚，并且只有在响应式值终止时才会提交或回滚。</p>
</div>
<div class="paragraph">
<p>这允许你的响应式方法以异步方式继续在事务上工作，直到他们的工作真正完成，而不仅仅是当响应式方法返回时。</p>
</div>
<div class="paragraph">
<p>如果你需要在你的响应式管道中传播你的事务上下文，请看 <a href="context-propagation.html">上下文传播指南</a> 。</p>
</div>
</div>
<div class="sect2">
<h3 id="programmatic-approach"><a class="anchor" href="#programmatic-approach"></a>Programmatic approach</h3>
<div class="paragraph">
<p>你可以使用 <code>QuarkusTransaction</code> 上的静态方法来定义事务边界。这提供了两种不同的选择，一种是允许你在事务范围内运行lambda的函数式方法，或者通过使用显式的 <code>begin</code> 、 <code>commit</code> 和 <code>rollback</code> 方法。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.narayana.jta.QuarkusTransaction;
import io.quarkus.narayana.jta.RunOptions;

public class TransactionExample {

    public void beginExample() {
        QuarkusTransaction.begin();
        //do work
        QuarkusTransaction.commit();

        QuarkusTransaction.begin(QuarkusTransaction.beginOptions()
                .timeout(10));
        //do work
        QuarkusTransaction.rollback();
    }

    public void runnerExample() {
        QuarkusTransaction.requiringNew().run(() -&gt; {
            //do work
        });
        QuarkusTransaction.joiningExisting().run(() -&gt; {
            //do work
        });

        int result = QuarkusTransaction.requiringNew()
                .timeout(10)
                .exceptionHandler((throwable) -&gt; {
                    if (throwable instanceof SomeException) {
                        return RunOptions.ExceptionResult.COMMIT;
                    }
                    return TransactionExceptionResult.ROLLBACK;
                })
                .call(() -&gt; {
                    //do work
                    return 0;
                });
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example shows a few different ways the API can be used.</p>
</div>
<div class="paragraph">
<p>The first method simply calls begin, does some work and commits it.
This created transaction is tied to the CDI request scope, so if it is still active when the request scope is destroyed then it will
be automatically rolled back. This removes the need to explicitly catch exceptions and call <code>rollback</code>, and acts as a safety net
against inadvertent transaction leaks, however it does mean that this can only be used when the request scope is active. The second
example in the method calls begin with a timeout option, and then rolls back the transaction.</p>
</div>
<div class="paragraph">
<p>The second method shows the use of lambda scoped transactions with <code>QuarkusTransaction.runner(&#8230;&#8203;)</code>;
the first example just runs a <code>Runnable</code> within a new transaction,
the second does the same but joining the existing transaction (if any),
and the third calls a <code>Callable</code> with some specific options.
In particular the <code>exceptionHandler</code> method can be used to control if the transaction is rolled back or not on exception.</p>
</div>
<div class="paragraph">
<p>支持以下语义：</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>QuarkusTransaction.disallowingExisting()</code>/<code>DISALLOW_EXISTING</code></dt>
<dd>
<p>如果一个事务已经与当前线程相关联，将抛出一个 <code>QuarkusTransactionException</code> ，否则将启动一个新的事务，并遵循所有正常的生命周期规则。</p>
</dd>
<dt class="hdlist1"><code>QuarkusTransaction.joiningExisting()</code>/<code>JOIN_EXISTING</code></dt>
<dd>
<p>如果没有活动的事务，那么一个新的事务将被启动，并在方法结束时提交。如果一个异常被抛出，由 <code>#exceptionHandler(Function)</code> 注册的异常处理程序将被调用，以决定TX是否应该被提交或回滚。如果一个现有的事务处于活动状态，那么该方法将在现有事务的背景下运行。如果抛出一个异常，将调用异常处理程序，但是 <code>ExceptionResult#ROLLBACK</code> 的结果将导致TX被标记为回滚，而 <code>ExceptionResult#COMMIT</code> 的结果将导致不采取任何行动。</p>
</dd>
<dt class="hdlist1"><code>QuarkusTransaction.requiringNew()</code>/<code>REQUIRE_NEW</code></dt>
<dd>
<p>If an existing transaction is already associated with the current thread then the transaction is suspended,
then a new transaction is started which follows all the normal lifecycle rules,
and when it&#8217;s complete the original transaction is resumed.
Otherwise, a new transaction is started, and follows all the normal lifecycle rules.</p>
</dd>
<dt class="hdlist1"><code>QuarkusTransaction.suspendingExisting()</code>/<code>SUSPEND_EXISTING</code></dt>
<dd>
<p>If no transaction is active then these semantics are basically a no-op.
If a transaction is active then it is suspended, and resumed after the task is run.
The exception handler will never be consulted when these semantics are in use, specifying both an exception handler and
these semantics are considered an error.
These semantics allows for code to easily be run outside the scope of a transaction.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="legacy-api-approach"><a class="anchor" href="#legacy-api-approach"></a>传统的API方法</h3>
<div class="paragraph">
<p>不太容易的方法是注入一个 <code>UserTransaction</code> ，并使用各种事务处理方法。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class SantaClausService {

    @Inject ChildDAO childDAO;
    @Inject SantaClausDAO santaDAO;
    @Inject UserTransaction transaction;

    public void getAGiftFromSanta(Child child, String giftDescription) {
        // some transaction work
        try {
            transaction.begin();
            Gift gift = childDAO.addToGiftList(child, giftDescription);
            santaDAO.addToSantaTodoList(gift);
            transaction.commit();
        }
        catch(SomeException e) {
            // do something on Tx failure
            transaction.rollback();
        }
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>你不能在一个由 <code>@Transactional</code> 控制事务启动的方法中使用 <code>UserTransaction</code> 。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-the-transaction-timeout"><a class="anchor" href="#configuring-the-transaction-timeout"></a>配置事务超时</h2>
<div class="sectionbody">
<div class="paragraph">
<p>你可以通过属性 <code>quarkus.transaction-manager.default-transaction-timeout</code> 来配置默认的事务超时，即适用于由事务管理器管理的所有事务的超时，指定为一个持续时间。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To write duration values, use the standard <code>java.time.Duration</code> format.
See the <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/time/Duration.html#parse(java.lang.CharSequence)">Duration#parse() javadoc</a> for more information.</p>
</div>
<div class="paragraph">
<p>You can also use a simplified format, starting with a number:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the value is only a number, it represents time in seconds.</p>
</li>
<li>
<p>If the value is a number followed by <code>ms</code>, it represents time in milliseconds.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In other cases, the simplified format is translated to the <code>java.time.Duration</code> format for parsing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the value is a number followed by <code>h</code>, <code>m</code>, or <code>s</code>, it is prefixed with <code>PT</code>.</p>
</li>
<li>
<p>If the value is a number followed by <code>d</code>, it is prefixed with <code>P</code>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>默认值是60秒。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-transaction-node-name-identifier"><a class="anchor" href="#configuring-transaction-node-name-identifier"></a>配置事务节点名称标识符</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Narayana作为底层事务管理器，有一个唯一节点标识符的概念。如果你考虑使用涉及多个资源的XA事务，这就很重要了。</p>
</div>
<div class="paragraph">
<p>节点名称标识符在交易的识别中起着至关重要的作用。当交易被创建时，节点名称标识符被做为成交易ID的一部分。基于节点名称标识符，事务管理器能够识别在数据库或JMS代理中创建的XA事务对应物。该标识符使事务管理器有可能在恢复期间回滚事务对应方。</p>
</div>
<div class="paragraph">
<p>节点名称标识符需要在每个事务管理器部署中是唯一的。而且节点标识符需要在事务管理器重新启动时保持不变。</p>
</div>
<div class="paragraph">
<p>节点名称标识符可以通过属性 <code>quarkus.transaction-manager.node-name</code> 进行配置。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="transaction-scope"><a class="anchor" href="#transaction-scope"></a>Using <code>@TransactionScoped</code> to bind CDI beans to the transaction lifecycle</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can define beans that live for as long as a transaction,
and through CDI lifecycle events perform actions when a transaction starts and ends.</p>
</div>
<div class="paragraph">
<p>Just assign the transaction <a href="cdi#bean-scope">scope</a> to such beans using the <code>@TransactionScoped</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@TransactionScoped
public class MyTransactionScopedBean {

    // The bean's state is bound to a specific transaction,
    // and restored even after suspending then resuming the transaction.
    int myData;

    @PostConstruct
    void onBeginTransaction() {
        // This gets invoked after a transaction begins.
    }

    @PreDestroy
    void onBeforeEndTransaction() {
        // This gets invoked before a transaction ends (commit or rollback).
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, if you don&#8217;t necessarily need to hold state during the transaction,
and just want to react to transaction start/end events,
you can simply declare event listeners in a differently scoped bean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class MyTransactionEventListeningBean {

    void onBeginTransaction(@Observes @Initialized(TransactionScoped.class) Object event) {
        // This gets invoked when a transaction begins.
    }

    void onBeforeEndTransaction(@Observes @BeforeDestroyed(TransactionScoped.class) Object event) {
        // This gets invoked before a transaction ends (commit or rollback).
    }

    void onAfterEndTransaction(@Observes @Destroyed(TransactionScoped.class) Object event) {
        // This gets invoked after a transaction ends (commit or rollback).
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>event</code> object represents the transaction ID, and defines <code>toString()</code>/<code>equals()</code>/<code>hashCode()</code> accordingly.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In listener methods, you can access more information about the transaction in progress by accessing the <code>TransactionManager</code>,
which is a CDI bean and can be <code>@Inject</code>ed.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jdbcstore"><a class="anchor" href="#jdbcstore"></a>Configure storing of Quarkus transaction logs in a database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In cloud environments where persistent storage is not available, such as when application containers are unable to use persistent volumes, you can configure the transaction management to store transaction logs in a database by using a Java Database Connectivity (JDBC) datasource.</p>
</div>
<div class="paragraph">
<p>However, in cloud-native apps, using a database to store transaction logs has additional requirements.
The <code>narayana-jta</code> extension, which manages these transactions, requires stable storage, a unique reusable node identifier, and a steady IP address to work correctly.
While the JDBC object store provides a stable storage, users must still plan how to meet the other two requirements.</p>
</div>
<div class="paragraph">
<p>Quarkus, after you evaluate whether using a database to store transaction logs is right for you, allows the following JDBC-specific configuration of the object store included in <code>quarkus.transaction-manager.object-store.<em>&lt;property&gt;</em></code> properties, where <em>&lt;property&gt;</em> can be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>type</code> (<em>string</em>): Configure this property to <code>jdbc</code> to enable usage of a Quarkus JDBC datasource for storing transaction logs.
The default value is <code>file-system</code>.</p>
</li>
<li>
<p><code>datasource</code> (<em>string</em>): Specify the name of the datasource for the transaction log storage.
If no value is provided for the <code>datasource</code> property, Quarkus uses the <a href="datasource#configure-datasources">default datasource</a>.</p>
</li>
<li>
<p><code>create-table</code> (<em>boolean</em>): When set to <code>true</code>, the transaction log table gets automatically created if it does not already exist.
The default value is <code>false</code>.</p>
</li>
<li>
<p><code>drop-table</code> (<em>boolean</em>): When set to <code>true</code>, the tables are dropped on startup if they already exist.
The default value is <code>false</code>.</p>
</li>
<li>
<p><code>table-prefix</code> (string): Specify the prefix for a related table name.
The default value is <code>quarkus_</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more configuration information, see the <strong>Narayana JTA - Transaction manager</strong> section of the Quarkus <a href="all-config">All configuration options</a> reference.</p>
</div>
<div class="ulist">
<div class="title">Additional information:</div>
<ul>
<li>
<p>Create the transaction log table during the initial setup by setting the <code>create-table</code> property to <code>true</code>.</p>
</li>
<li>
<p>JDBC datasources and ActiveMQ Artemis allow the enlistment and automatically register the <code>XAResourceRecovery</code>.</p>
<div class="ulist">
<ul>
<li>
<p>JDBC datasources is part of <code>quarkus-agroal</code>, and it needs to use <code>quarkus.datasource.jdbc.transactions=XA</code>.</p>
</li>
<li>
<p>ActiveMQ Artemis is part of <code>quarkus-pooled-jms</code>, and it needs to use <code>quarkus.pooled-jms.transaction=XA</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>To ensure data integrity in case of application crashes or failures, enable the transaction crash recovery with the <code>quarkus.transaction-manager.enable-recovery=true</code> configuration.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To work around the current known issue of <a href="https://issues.redhat.com/browse/AG-209">Agroal having a different view on running transaction checks</a>, set the datasource transaction type for the datasource responsible for writing the transaction logs to <code>disabled</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>quarkus.datasource.TX_LOG.jdbc.transactions=disabled</pre>
</div>
</div>
<div class="paragraph">
<p>This example uses TX_LOG as the datasource name.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="why-always-having-a-transaction-manager"><a class="anchor" href="#why-always-having-a-transaction-manager"></a>为什么总是有一个事务处理器？</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">它能在我希望的所有地方工作吗？</dt>
<dd>
<p>是的，它在你的Quarkus应用程序中，在你的IDE中，在你的测试中都可以使用，因为这些都是Quarkus应用程序。JTA对一些人来说有一些不好的影响。我不知道为什么。我们只能说，这不是老旧的JTA实现。我们所拥有的是完美的可嵌入的和精简的实现。</p>
</dd>
<dt class="hdlist1">两阶段提交是否会减慢了我的应用程序？</dt>
<dd>
<p>不，这是一个古老的民间故事。让我们假设它基本上是免费的，让你根据需要扩展到涉及几个数据源的更复杂的情况。</p>
</dd>
<dt class="hdlist1">当我做只读操作时，就不需要事务，这样会更快</dt>
<dd>
<p>Wrong.<br>
First off, just disable the transaction by marking your transaction boundary with <code>@Transactional(NOT_SUPPORTED)</code> (or <code>NEVER</code> or <code>SUPPORTS</code> depending on the semantic you want).<br>
Second, it&#8217;s again fairy tale that not using transaction is faster.
The answer is, it depends on your DB and how many SQL SELECTs you are making.
No transaction means the DB does have a single operation transaction context anyway.<br>
Third, when you do several SELECTs, it&#8217;s better to wrap them in a single transaction because they will all be consistent with one another.
Say your DB represents your car dashboard, you can see the number of kilometers remaining and the fuel gauge level.
By reading it in one transaction, they will be consistent.
If you read one and the other from two different transactions, then they can be inconsistent.
It can be more dramatic if you read data related to rights and access management for example.</p>
</dd>
<dt class="hdlist1">为什么相对Hibernate 的事务管理 API你更推荐JTA</dt>
<dd>
<p>通过 <code>entityManager.getTransaction().begin()</code> 和手动管理事务会导致一段丑陋的代码，最终人们会出错。 事务也与 JMS 和其他数据库访问有关，因此一个 API 更有意义。</p>
</dd>
<dt class="hdlist1">It&#8217;s a mess because I don&#8217;t know if my Jakarta Persistence persistence unit is using <code>JTA</code> or <code>Resource-level</code> Transaction</dt>
<dd>
<p>It&#8217;s not a mess in Quarkus :)
Resource-level was introduced to support Jakarta Persistence in a non-managed environment.
But Quarkus is both lean and a managed environment, so we can safely always assume we are in JTA mode.
The end result is that the difficulties of running Hibernate ORM + CDI + a transaction manager in Java SE mode are solved by Quarkus.</p>
</dd>
</dl>
</div>
</div>
</div>
    </div>
    <div class="grid__item width-4-12 width-12-12-m tocwrapper">
      <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#setting-it-up">设置它</a></li>
<li><a href="#starting-and-stopping-transactions-defining-your-boundaries">开始和停止事务：确定你的事务边界</a>
<ul class="sectlevel2">
<li><a href="#declarative-approach">声明式方法</a></li>
<li><a href="#transaction-configuration">Transaction configuration</a></li>
<li><a href="#reactive-extensions">响应性扩展</a></li>
<li><a href="#programmatic-approach">Programmatic approach</a></li>
<li><a href="#legacy-api-approach">传统的API方法</a></li>
</ul>
</li>
<li><a href="#configuring-the-transaction-timeout">配置事务超时</a></li>
<li><a href="#configuring-transaction-node-name-identifier">配置事务节点名称标识符</a></li>
<li><a href="#transaction-scope">Using <code>@TransactionScoped</code> to bind CDI beans to the transaction lifecycle</a></li>
<li><a href="#jdbcstore">Configure storing of Quarkus transaction logs in a database</a></li>
<li><a href="#why-always-having-a-transaction-manager">为什么总是有一个事务处理器？</a></li>
</ul></div>
    </div>
  </div>
  </div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license. <i class='fab fa-creative-commons'></i><i class='fab fa-creative-commons-by'></i> <a href='https://creativecommons.org/licenses/by/3.0/' target='_blank'>CC by 3.0</a><br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">Home</a></li>
          
          
          
            <li><a href="/about" target="_blank">About</a></li>
          
          
          
            <li><a href="/blog" target="_blank">博客</a></li>
          
          
          
            <li><a href="/insights" target="_blank">Podcast</a></li>
          
          
          
            <li><a href="/events" target="_blank">活动</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">新闻</a></li>
          
          
          
            <li><a href="/userstories" target="_blank">User Stories</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">路线图</a></li>
          
          
          
            <li><a href="/security" target="_blank">Security&nbsp;policy</a></li>
          
          
          
            <li><a href="/usage" target="_blank">Usage</a></li>
          
          
          
            <li><a href="https://github.com/commonhaus/artwork/tree/main/projects/quarkus" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
          
            <li><a href="https://www.redhat.com/en/about/privacy-policy" target="_blank">Privacy Policy</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Follow Us</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a href="https://bsky.app/profile/quarkus.io" target="_blank">Bluesky</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.threads.com/@quarkusio" target="_blank">Threads</a></li>
          
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">Support</a></li>
          
          
          
            <li><a href="/guides" target="_blank">Guides</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">开始体验</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">Discussions</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">Development mailing list</a></li>
          
          
          
            <li><a href="https://stats.uptimerobot.com/ze1PfweT2p" target="_blank">Quarkus Service Status</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
          
            <li><a href="https://quarkus.io/" target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href="https://es.quarkus.io/" target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href="https://ja.quarkus.io/" target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkus is made of community projects</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">And many more...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content cf-footer">
  <div class="flexcontainer">
    <div class="cf-logo">
      <a class="cf-logo" href="https://www.commonhaus.org/" target="_blank"><img src="https://raw.githubusercontent.com/commonhaus/artwork/main/foundation/brand/svg/CF_logo_horizontal_single_reverse.svg"/></a>
    </div>
    <div class="license">
      Copyright © Quarkus. All rights reserved. For details on our trademarks, please visit our <a href="https://www.commonhaus.org/policies/trademark-policy/">Trademark Policy</a> and <a href="https://www.commonhaus.org/trademarks/">Trademark List</a>. Trademarks of third parties are owned by their respective holders and their mention here does not suggest any endorsement or association.
    </div>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
  <script src="/assets/javascript/randomize.js" type="text/javascript"></script>
  <script src="/assets/javascript/time.js" type="text/javascript"></script>
</body>

</html>
